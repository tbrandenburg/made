name: NodeJS Frontend Preview

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      timeout_minutes:
        description: 'Preview timeout in minutes'
        required: false
        default: '5'
        type: string

jobs:
  preview:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # small buffer above 10-minute tunnel lifetime

    env:
      PREVIEW_TIMEOUT_MINUTES: ${{ github.event.inputs.timeout_minutes || '5' }}
      NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install latest ngrok CLI (v4)
        run: |
          echo "üîß Installing official ngrok CLI (v4)..."
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | \
            sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | \
            sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt-get update -y
          sudo apt-get install -y ngrok
          echo "‚úÖ Installed $(ngrok version)"

      - name: Detect Node.js frontend directory
        id: detect
        run: |
          echo "üîç Searching for Node.js frontend in this PR branch..."
          
          # Look for frontend specifically (exclude root package.json)
          frontend_package=""
          if [ -f "packages/frontend/package.json" ]; then
            # Check if it has vite or other frontend dev script
            if jq -e '.scripts.dev and (.dependencies.react or .devDependencies.vite)' packages/frontend/package.json > /dev/null 2>&1; then
              frontend_package="packages/frontend"
            fi
          fi
          
          if [ -z "$frontend_package" ]; then
            echo "::warning::No frontend package detected in packages/frontend. This is expected for backend-only changes."
            echo "ü™Ñ Skipping preview deployment ‚Äî no frontend present."
            echo "frontend_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "‚úÖ Found frontend package at: $frontend_package"
          echo "frontend_dir=$frontend_package" >> $GITHUB_OUTPUT
          echo "frontend_found=true" >> $GITHUB_OUTPUT

      - name: Set up Python
        if: ${{ steps.detect.outputs.frontend_found == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install UV
        if: ${{ steps.detect.outputs.frontend_found == 'true' }}
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      # ------------------------------------------------------
      # Install OpenCode (binary install)
      # ------------------------------------------------------
      - name: Install sst/opencode
        if: ${{ steps.detect.outputs.frontend_found == 'true' }}
        run: |
          set -euo pipefail
          INSTALL_DIR="$HOME/.opencode/bin"
          mkdir -p "$INSTALL_DIR"

          TMPDIR="$(mktemp -d)"
          trap 'rm -rf "$TMPDIR"' EXIT
          ARCHIVE_PATH="$TMPDIR/opencode.tar.gz"

          curl -fsSL "https://github.com/sst/opencode/releases/latest/download/opencode-linux-x64.tar.gz" -o "$ARCHIVE_PATH"
          tar -xzf "$ARCHIVE_PATH" -C "$TMPDIR"
          install "$TMPDIR/opencode" "$INSTALL_DIR/opencode"

          echo "$INSTALL_DIR" >> "$GITHUB_PATH"
      
      - name: Install dependencies
        if: ${{ steps.detect.outputs.frontend_found == 'true' }}
        run: make install

      - name: Debug frontend dependencies 
        if: ${{ steps.detect.outputs.frontend_found == 'true' }}
        run: |
          echo "üîç Debugging frontend setup..."
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Frontend package.json:"
          cat packages/frontend/package.json
          echo ""
          echo "Checking if vite is available:"
          cd packages/frontend && npx vite --version || echo "‚ùå Vite not found"
          echo "Checking node_modules:"
          ls -la packages/frontend/node_modules/.bin/ | grep vite || echo "‚ùå No vite binary found"

      - name: Start MADE services (frontend + backend)
        if: ${{ steps.detect.outputs.frontend_found == 'true' }}
        run: |
          echo "üöÄ Starting MADE services with make run..."
          
          # Start both frontend and backend using make run
          nohup make run > services.log 2>&1 &
          SERVICES_PID=$!
          echo "Services started with PID $SERVICES_PID"
          
          echo "‚è≥ Waiting for services to become available..."
          
          # Wait a bit and check if the process is still running
          sleep 5
          if ! kill -0 $SERVICES_PID 2>/dev/null; then
            echo "‚ùå Services process died unexpectedly!"
            echo "üîç Full services.log output:"
            cat services.log
            exit 1
          fi
          
          # Wait for backend API
          for i in {1..30}; do
            if curl -f http://localhost:3000/api/repositories > /dev/null 2>&1; then
              echo "‚úÖ Backend API is ready on port 3000"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "‚ùå Backend API never became ready"
              echo "üîç Services log:"
              tail -n 30 services.log || true
              exit 1
            fi
            sleep 3
          done
          
          # Wait for frontend
          for i in {1..30}; do
            if nc -z localhost 5173 2>/dev/null; then
              echo "‚úÖ Frontend is ready on port 5173"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "‚ùå Frontend never became ready on port 5173"
              echo "üîç Services log:"
              tail -n 30 services.log || true
              exit 1
            fi
            sleep 2
          done
          
          echo "üîç Last few lines of services.log:"
          tail -n 15 services.log || true

      - name: Start ngrok tunnel (v4 CLI, verbose)
        if: ${{ steps.detect.outputs.frontend_found == 'true' }}
        id: ngrok
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
        run: |
          echo "üåê Establishing ngrok tunnel (v4, verbose mode enabled)..."
          echo "üîë Using NGROK_AUTHTOKEN from environment (not stored on disk)."

          echo "üîé Checking for active services..."
          frontend_ready=false
          backend_ready=false
          
          # Check frontend (primary target for preview)
          if nc -z localhost 5173; then
            frontend_ready=true
            target_port=5173
            echo "‚úÖ Frontend detected on port 5173 (primary target)"
          fi
          
          # Check backend API
          if nc -z localhost 3000; then
            backend_ready=true
            echo "‚úÖ Backend API detected on port 3000"
          fi
          
          # Fallback to other common ports if frontend not found
          if [ "$frontend_ready" = false ]; then
            for port in 3000 8080; do
              echo "   Testing fallback port $port..."
              if nc -z localhost $port; then
                target_port=$port
                echo "‚úÖ Detected service on fallback port $target_port"
                break
              fi
            done
          fi

          if [ -z "$target_port" ]; then
            echo "‚ùå Could not detect active services on ports (5173, 3000, 8080)."
            echo "ü™µ Showing last 20 lines of services.log:"
            tail -n 20 services.log || true
            exit 1
          fi
          
          echo "üéØ Using port $target_port for preview (frontend: $frontend_ready, backend: $backend_ready)"

          echo "üöÄ Starting ngrok for port $target_port (v4 CLI)..."
          ngrok version

          # Start ngrok v4 CLI directly with environment auth token
          nohup ngrok http $target_port --log=stdout > ngrok.log 2>&1 &
          NGROK_PID=$!
          echo "üß© ngrok process started with PID $NGROK_PID"
          sleep 3

          echo "‚è≥ Waiting for ngrok API (http://127.0.0.1:4040) to become available..."
          for i in {1..30}; do
            url=$(curl -s --max-time 2 http://127.0.0.1:4040/api/tunnels | grep -o 'https://[^"]*' | head -n 1 || true)
            if [ -n "$url" ]; then
              echo "‚úÖ ngrok tunnel established successfully: $url"
              echo "preview_url=$url" >> $GITHUB_OUTPUT
              break
            fi

            echo "   ...still waiting ($i/30)"
            # Show partial ngrok log every 5 iterations for visibility
            if (( i % 5 == 0 )); then
              echo "üîç Partial ngrok log:"
              tail -n 10 ngrok.log || true
            fi
            sleep 2
          done

          if [ -z "$url" ]; then
            echo "‚ùå ngrok tunnel failed to start within timeout."
            echo "üßæ Full ngrok log output for debugging:"
            cat ngrok.log || true
            echo "üß® Killing ngrok process PID $NGROK_PID"
            kill $NGROK_PID || true
            exit 1
          fi

          echo "üéâ ngrok setup complete and verified."

      - name: Send Telegram message
        if: ${{ steps.detect.outputs.frontend_found == 'true' && success() }}
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          REPO=${{ github.repository }}
          PREVIEW_URL="${{ steps.ngrok.outputs.preview_url }}"
          TIMEOUT_MINUTES=${{ env.PREVIEW_TIMEOUT_MINUTES }}
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER=${{ github.event.pull_request.number }}
            PR_TITLE="${{ github.event.pull_request.title }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"
            
            ESCAPED_TITLE=$(echo "$PR_TITLE" | sed 's/[-_*\[\]()~`>#+=|{}.!]/\\&/g')
            ESCAPED_AUTHOR=$(echo "$AUTHOR" | sed 's/[-_*\[\]()~`>#+=|{}.!]/\\&/g')
            ESCAPED_REPO=$(echo "$REPO" | sed 's/[-_*\[\]()~`>#+=|{}.!]/\\&/g')

            MSG=$(printf '%s\n' \
              "üöÄ *Preview ready for PR \\#$PR_NUMBER in $ESCAPED_REPO*" \
              "" \
              "*Title:* $ESCAPED_TITLE" \
              "*Author:* $ESCAPED_AUTHOR" \
              "" \
              "*Live Preview:* [Open Preview]($PREVIEW_URL)" \
              "*Workflow:* [View Run]($WORKFLOW_URL)" \
              "‚è≥ *This preview will expire in ${TIMEOUT_MINUTES} minutes\.*" \
              "" \
              "[View on GitHub](https://github.com/$REPO/pull/$PR_NUMBER)"
            )
          else
            # Manual dispatch
            BRANCH_NAME="${{ github.ref_name }}"
            ACTOR="${{ github.actor }}"
            
            ESCAPED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[-_*\[\]()~`>#+=|{}.!]/\\&/g')
            ESCAPED_ACTOR=$(echo "$ACTOR" | sed 's/[-_*\[\]()~`>#+=|{}.!]/\\&/g')
            ESCAPED_REPO=$(echo "$REPO" | sed 's/[-_*\[\]()~`>#+=|{}.!]/\\&/g')

            MSG=$(printf '%s\n' \
              "üöÄ *Manual preview deployed for $ESCAPED_REPO*" \
              "" \
              "*Branch:* $ESCAPED_BRANCH" \
              "*Triggered by:* $ESCAPED_ACTOR" \
              "" \
              "*Live Preview:* [Open Preview]($PREVIEW_URL)" \
              "*Workflow:* [View Run]($WORKFLOW_URL)" \
              "‚è≥ *This preview will expire in ${TIMEOUT_MINUTES} minutes\.*"
            )
          fi

          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
            -d "chat_id=$CHAT_ID" \
            -d "parse_mode=MarkdownV2" \
            --data-urlencode "text=$MSG"

      - name: Keep ngrok alive
        if: ${{ steps.detect.outputs.frontend_found == 'true' }}
        run: |
          echo "‚è≥ Keeping ngrok tunnel alive for $PREVIEW_TIMEOUT_MINUTES minutes..."
          sleep $(( PREVIEW_TIMEOUT_MINUTES * 60 ))