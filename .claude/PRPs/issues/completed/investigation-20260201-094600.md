# Investigation: Copilot Agent CLI Session History Shows All Sessions Instead of Workspace-Scoped

**Issue**: Free-form investigation
**Type**: BUG
**Investigated**: 2026-02-01T09:46:00Z

### Assessment

| Metric     | Value    | Reasoning                                                                                                                                                            |
| ---------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Severity   | HIGH     | Major feature broken since users see sessions from all directories making it difficult to find relevant sessions for their current workspace, significantly impacting productivity with no proper workaround |
| Complexity | LOW      | Only 1-2 files need modification, the fix involves copying working patterns from Codex CLI, isolated change with low risk since other CLIs already implement this correctly |
| Confidence | HIGH     | Clear root cause identified with strong evidence from codebase exploration, working reference implementations available, and actual session data confirms the workspace information is stored properly but not being used for filtering |

---

## Problem Statement

The Copilot Agent CLI shows session history for all directories instead of filtering sessions to match the current repository/workspace, making it difficult for users to find relevant sessions when working in a specific project.

---

## Analysis

### Root Cause Analysis

WHY: Session history shows sessions from all directories
↓ BECAUSE: `CopilotAgentCLI.list_sessions()` doesn't filter sessions by workspace
Evidence: `copilot_agent_cli.py:344-392` - No call to `_session_matches_directory()` like other CLIs

↓ BECAUSE: `_session_matches_directory()` is incorrectly implemented and only checks directory existence
Evidence: `copilot_agent_cli.py:85-93` - `return session_path.exists()` instead of reading workspace metadata

↓ BECAUSE: Method doesn't read the `session.start` event from `events.jsonl` to extract workspace information  
Evidence: Session files contain `"context":{"cwd":"/path/to/workspace"}` but this is never read

↓ ROOT CAUSE: The `_session_matches_directory()` method only checks if session directory exists rather than reading and comparing workspace paths from the `session.start` event in `events.jsonl` files
Evidence: `copilot_agent_cli.py:89` - `return session_path.exists()` instead of JSON parsing logic

### Evidence Chain

**Current Broken Implementation:**
```python
# copilot_agent_cli.py:85-93
def _session_matches_directory(self, session_id: str, cwd: Path) -> bool:
    """Check whether a session belongs to the provided working directory."""
    sessions_dir = self._get_sessions_directory()
    if not sessions_dir:
        return False

    # Copilot CLI session directories are named with session IDs  
    session_path = sessions_dir / session_id
    return session_path.exists()  # ❌ Only checks existence, not workspace!
```

**Session Data Evidence:**
```json
{"type":"session.start","data":{"sessionId":"62f69e36-6ff9-4d03-b9a7-e059e1ca6565","context":{"cwd":"/home/tom/workspace/ai/made/workspace/.made/knowledge","gitRoot":"/home/tom/workspace/ai/made/workspace/.made/knowledge"}}}
{"type":"session.start","data":{"sessionId":"19d276e2-d64a-4ee5-9c26-196e727244cf","context":{"cwd":"/home/tom/workspace/ai/made/workspace/made/dev/poc-agent-cli-integration","gitRoot":"/home/tom/workspace/ai/made/workspace/made"}}}
```

**Missing Filtering in list_sessions:**
```python
# copilot_agent_cli.py:344-392 - NO workspace filtering applied
for session_dir in sessions_dir.iterdir():
    session_id = session_dir.name
    # ❌ Missing: if cwd and not self._session_matches_directory(session_id, cwd): continue
    sessions.append(SessionInfo(...))  # Adds ALL sessions
```

### Affected Files

| File                                      | Lines   | Action | Description                                    |
| ----------------------------------------- | ------- | ------ | ---------------------------------------------- |
| `packages/pybackend/copilot_agent_cli.py` | 85-93   | UPDATE | Fix `_session_matches_directory` method        |
| `packages/pybackend/copilot_agent_cli.py` | 344-392 | UPDATE | Add workspace filtering to `list_sessions`     |
| `packages/pybackend/tests/unit/test_copilot_agent_cli.py` | 415-445 | UPDATE | Fix and expand tests for workspace filtering   |

### Integration Points

- `agent_service.py:get_agent_cli()` → `CopilotAgentCLI.list_sessions(cwd)`
- `copilot_agent_cli.py:109` - `run_agent()` calls `_session_matches_directory` for validation  
- Frontend Repository/Knowledge pages call backend session APIs
- Session resumption relies on correct workspace matching

### Git History

- **Session storage**: Sessions stored in `~/.copilot/session-state/<session_id>/events.jsonl`
- **Working implementations**: Codex CLI (`codex_agent_cli.py:96-143`) and Kiro CLI (`kiro_agent_cli.py:78-94`) already implement correct workspace filtering
- **Issue scope**: Affects all users of Copilot Agent CLI across different projects

---

## Implementation Plan

### Step 1: Fix `_session_matches_directory` Method

**File**: `packages/pybackend/copilot_agent_cli.py`
**Lines**: 85-93
**Action**: UPDATE

**Current code:**
```python
def _session_matches_directory(self, session_id: str, cwd: Path) -> bool:
    """Check whether a session belongs to the provided working directory."""
    sessions_dir = self._get_sessions_directory()
    if not sessions_dir:
        return False

    # Copilot CLI session directories are named with session IDs  
    session_path = sessions_dir / session_id
    return session_path.exists()
```

**Required change:**
```python
def _session_matches_directory(self, session_id: str, cwd: Path) -> bool:
    """Check whether a session belongs to the provided working directory."""
    sessions_dir = self._get_sessions_directory()
    if not sessions_dir:
        return False

    # Copilot CLI session directories are named with session IDs  
    session_path = sessions_dir / session_id
    if not session_path.exists():
        return False
    
    # Read workspace information from events.jsonl
    events_file = session_path / "events.jsonl"
    if not events_file.exists():
        return False
        
    try:
        with open(events_file, "r", encoding="utf-8") as f:
            # Read first line to get session.start event
            first_line = f.readline().strip()
            if first_line:
                event = json.loads(first_line)
                if event.get("type") == "session.start":
                    context = event.get("data", {}).get("context", {})
                    session_cwd = context.get("cwd")
                    session_git_root = context.get("gitRoot")
                    
                    if session_cwd:
                        session_cwd_path = Path(session_cwd).resolve()
                        cwd_resolved = cwd.resolve()
                        
                        # Check if current directory is within session's workspace
                        try:
                            cwd_resolved.relative_to(session_cwd_path)
                            return True
                        except ValueError:
                            pass
                            
                        # Check if session directory is within current workspace
                        try:
                            session_cwd_path.relative_to(cwd_resolved)
                            return True
                        except ValueError:
                            pass
                            
                        # Check git root matching if available
                        if session_git_root:
                            session_git_root_path = Path(session_git_root).resolve()
                            try:
                                cwd_resolved.relative_to(session_git_root_path)
                                return True
                            except ValueError:
                                pass
                                
    except (json.JSONDecodeError, OSError, AttributeError) as e:
        logger.debug(f"Error reading session metadata for {session_id}: {e}")
        return False
        
    return False
```

**Why**: This change reads the actual workspace metadata from the session.start event and performs proper path comparison, matching the pattern used by Codex CLI.

---

### Step 2: Add Workspace Filtering to `list_sessions`

**File**: `packages/pybackend/copilot_agent_cli.py`
**Lines**: 344-392
**Action**: UPDATE

**Current code (relevant section):**
```python
# Around line 376-386
for session_dir in sessions_dir.iterdir():
    if session_dir.is_dir():
        session_id = session_dir.name
        # ... build SessionInfo ...
        sessions.append(session_info)
```

**Required change:**
```python
# Around line 376-386  
for session_dir in sessions_dir.iterdir():
    if session_dir.is_dir():
        session_id = session_dir.name
        
        # Filter by workspace if cwd is provided
        if cwd and not self._session_matches_directory(session_id, cwd):
            continue
            
        # ... build SessionInfo ...
        sessions.append(session_info)
```

**Why**: This ensures that only sessions matching the current workspace are included in the results, consistent with Codex and Kiro CLI behavior.

---

### Step 3: Add Required Import

**File**: `packages/pybackend/copilot_agent_cli.py`  
**Lines**: Top of file
**Action**: UPDATE

**Add import:**
```python
import json
```

**Why**: The new `_session_matches_directory` implementation requires JSON parsing for reading session metadata.

---

### Step 4: Update and Expand Tests

**File**: `packages/pybackend/tests/unit/test_copilot_agent_cli.py`
**Lines**: 415-445
**Action**: UPDATE

**Current test:**
```python
def test_session_matches_directory(self):
    # Only checks directory existence
    pass
```

**Required test cases:**
```python
def test_session_matches_directory_with_workspace_matching(self):
    """Test that _session_matches_directory correctly reads and compares workspace paths."""
    # Test case 1: Exact workspace match
    # Test case 2: Subdirectory of workspace  
    # Test case 3: Parent directory of workspace
    # Test case 4: Git root matching
    # Test case 5: No match - different workspace
    # Test case 6: Invalid/missing events.jsonl
    # Test case 7: Malformed JSON in events.jsonl

def test_list_sessions_filters_by_workspace(self):
    """Test that list_sessions only returns sessions from current workspace."""
    # Create test sessions from different workspaces
    # Verify filtering works correctly
```

---

## Patterns to Follow

**From Codex CLI - mirror this workspace matching logic:**

```python
# SOURCE: codex_agent_cli.py:118-138
# Pattern for reading session metadata and path comparison
try:
    with open(session_file, "r", encoding="utf-8") as f:
        first_line = f.readline().strip()
        if first_line:
            event = json.loads(first_line)
            if event.get("type") == "session_meta":
                payload = event.get("payload", {})
                session_cwd = payload.get("cwd")
                if session_cwd:
                    session_cwd_path = Path(session_cwd).resolve()
                    cwd_resolved = cwd.resolve()
                    
                    # Check if paths are related (parent/child relationship)
                    try:
                        cwd_resolved.relative_to(session_cwd_path)
                        return True
                    except ValueError:
                        pass
                        
                    try:
                        session_cwd_path.relative_to(cwd_resolved)  
                        return True
                    except ValueError:
                        pass
```

**From Codex CLI - mirror this filtering application:**

```python
# SOURCE: codex_agent_cli.py:418-421
# Pattern for applying workspace filtering in list_sessions
if cwd and not self._session_matches_directory(session_id, cwd):
    continue
```

---

## Edge Cases & Risks

| Risk/Edge Case                           | Mitigation                                                          |
| ---------------------------------------- | ------------------------------------------------------------------- |
| Missing events.jsonl file               | Return False, log debug message                                     |
| Malformed JSON in events.jsonl          | Catch JSONDecodeError, return False                                 |
| Missing session.start event             | Check event type before processing                                  |
| Path resolution errors                   | Catch ValueError from relative_to(), continue checking other paths  |
| Performance impact from file I/O         | Only read first line of events.jsonl, cache results if needed      |
| Backward compatibility                   | Graceful fallback to existence check if metadata reading fails     |

---

## Validation

### Automated Checks

```bash
cd packages/pybackend
uv run python -m pytest tests/unit/test_copilot_agent_cli.py::test_session_matches_directory -v
uv run python -m pytest tests/unit/test_copilot_agent_cli.py::test_list_sessions_with_directory -v
uv run python -c "import copilot_agent_cli; print('Import successful')"
```

### Manual Verification

1. Create test sessions in different directories using Copilot Agent CLI
2. Run `copilot_agent_cli.list_sessions(Path("/specific/workspace"))` and verify only matching sessions returned
3. Test from different workspace directories to confirm filtering works
4. Verify session resumption still works correctly with workspace validation
5. Test edge cases: missing files, malformed JSON, permission errors

---

## Scope Boundaries

**IN SCOPE:**
- Fix `_session_matches_directory` to read workspace metadata from events.jsonl
- Add workspace filtering to `list_sessions` method
- Update tests to validate workspace filtering behavior
- Ensure compatibility with existing session format

**OUT OF SCOPE (do not touch):**
- Codex CLI or Kiro CLI implementations (already working correctly)
- Session storage format or events.jsonl structure
- Frontend UI changes (will automatically benefit from backend fix)
- Migration of existing sessions (they already contain correct metadata)
- Performance optimizations (basic fix first, optimize later if needed)

---

## Metadata

- **Investigated by**: Claude
- **Timestamp**: 2026-02-01T09:46:00Z
- **Artifact**: `.claude/PRPs/issues/investigation-20260201-094600.md`